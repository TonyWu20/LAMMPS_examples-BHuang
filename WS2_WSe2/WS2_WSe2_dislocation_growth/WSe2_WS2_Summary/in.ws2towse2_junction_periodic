units real 
dimension 3
atom_style atomic
boundary p p f

neighbor 2.0 bin 
neigh_modify delay 0
newton on
read_data ./ws2_wse2_junction_periodic.lmp

mass 3 183.84
mass 1 32.065
mass 2 78.97

group W type 3
group Se type 2
group S type 1

variable W_plane_height equal ave(z)
compute avg_z W reduce ave z
variable W_plane_height equal 2.095

variable W_threshold equal 1.5
variable S_Se_threshold equal 2.5

variable zmin equal bound(zmin,all)
region bottom_layer block 0.0 256 0.0 72 0.0 7.1
group bottom_layer region bottom_layer

#fix freeze_bottom bottom_layer setforce 0.0 0.0 0.0
#velocity bottom_layer set 0.0 0.0 0.0
fix substrate all wall/lj93 zlo 0.0 0.1 2.3 5.3

pair_style reaxff NULL
pair_coeff * * ./ffield.reax.wses  S Se W
fix qeq_all all qeq/reaxff 1 0.0 10 1e-6 reaxff
fix charge all property/atom q
fix fix_momentum all momentum 1 linear 1 1 1 rescale angular
#fix oz all enforce2d

timestep 0.1
min_style cg
minimize 1e-8 1e-8 5000 5000

#velocity all create 600.0 4928459 mom yes rot yes dist gaussian

thermo 100
thermo_style custom step temp pe etotal
thermo_modify lost ignore flush yes  
dump anneal all custom 100 ws2towse2_junction_periodic.dump id type x y z  #c_diff[1] c_diff[2] c_diff[3]

#1st :Heating
fix heat_W W nvt temp 600.0 1100.0 $(100.0*dt)
fix heat_Se Se nvt temp 600.0 900.0 $(100.0*dt)
fix heat_S S nvt temp 600.0 600.0 $(100.0*dt)
#fix oz all enforce2d
run 5000
unfix heat_W
unfix heat_Se
unfix heat_S

variable W_out_condition atom "abs(z - v_W_plane_height) > v_W_threshold"
variable S_out_condition atom "abs(z - v_W_plane_height) > v_S_Se_threshold"
variable Se_out_condition atom "abs(z - v_W_plane_height) > v_S_Se_threshold"

group W_out_of_plane_atoms dynamic W var W_out_condition
group S_out_of_plane_atoms dynamic S var S_out_condition
group Se_out_of_plane_atoms dynamic Se var Se_out_condition

#2nd :High-T Relaxation
fix relax_W  W npt temp 1100.0 1100.0 $(100.0*dt) y 0 0 $(100.0*dt)
fix relax_Se Se nvt temp 900.0 900.0 $(100.0*dt)
fix relax_S  S nvt temp 600.0 600.0 $(100.0*dt)
run 25000

variable W_out_num equal count(W_out_of_plane_atoms)
variable S_out_num equal count(S_out_of_plane_atoms)
variable Se_out_num equal count(Se_out_of_plane_atoms)
print "Number of W atoms significantly out of plane: ${W_out_num}"
print "Number of S atoms significantly out of plane: ${S_out_num}"
print "Number of Se atoms significantly out of plane: ${Se_out_num}"
delete_atoms group W_out_of_plane_atoms
delete_atoms group S_out_of_plane_atoms
delete_atoms group Se_out_of_plane_atoms

unfix relax_W
unfix relax_Se
unfix relax_S

#3rd :Cooling
fix cool_W  W nvt temp 1100.0 600.0 $(100.0*dt)
fix cool_Se Se nvt temp 900.0 600.0 $(100.0*dt)
fix cool_S  S nvt temp 600.0 600.0 $(100.0*dt)
run 5000
unfix cool_W
unfix cool_Se
unfix cool_S

#4th :Low-T Relaxation
fix relax2 all nvt temp 600.0 600.0 $(100.0*dt)
run 5000
unfix relax2

min_style cg
minimize 1e-8 1e-8 5000 5000
